
[TOC]

# 推荐系统工程化

## 系统架构

### 抓取聚合信息流推荐

#### 特点
* 用于用户的阅读兴趣
* 架构更接近搜索引擎

#### 核心模块

##### 内容采集
* 功能
    * 抓取、清洗外部内容源的内容
    * 对内容做挖掘和分析，得到结构化的标签、分类信息

##### 离线计算
* 核心：快速的搭建出数据管道
* 功能：生成用户画像、召回的候选结果、排序模型
* 输出
    * 推荐结果
    * 用户画像
    * 排序模型
* 构建：基于分布式计算集群（Hadoop, Spark, TensorFlow）

##### 推荐服务
* 作用：在需要时，提供一批新的内容
* 功能
    * 融合离线推荐和实时召回
    * 个性化的实时排序
    * 排除已曝光的内容



### 个性化首页

#### 总体

* 分三层：在线层、近线层、离线层

##### 数据流
* 行为事件数据被实时收集
    * 一边进入分布式文件系统，供离线层使用
    * 一边进入消息队列，供近线层使用
* 全量数据被抽取进行离线计算，生成推荐结果或模型
* 离线层的计算结果会在近线层被更新，在在线层被直接使用


#### 在线层

##### 优势
* 对场景信息敏感
* 了解用户请求时的上下文
* 立即满足用户

##### 约束
* 有响应时间硬要求
* 要保证可用性、稳定性
* 计算复杂度有限
* 需要有降级服务：热门排行榜

##### 典型任务
* 过滤逻辑：过滤看过的，被删除的
* 运营手段
* 融合排序
* 多样性提升：去掉高度相似的物品

#### 离线层

##### 任务
* 训练模型
* 计算推荐结果

##### 优势
* 处理大量数据
* 运行批量任务
* 计算能力可水平扩展

##### 典型任务
* 批量运行机器学习算法
* 批量计算推荐结果
* 挖掘用户标签
* 物品内容分析

#### 近线层

##### 优势
* 捕捉用户最新兴趣
* 运行较复杂的学习算法
* 较及时给用户响应

##### 约束
* 处理的数据量有限

##### 典型任务
* 补充召回结果
* 小批量样本更新模型参数

##### 核心
* 流计算


### 蓝本架构

#### 简化个性化首页
* 去除近线层
* 避免使用分布式系统



## 日志收集

### 用途
* 指标报表
* 数据分析
* 机器学习

### 要点

#### 数据模型
* 用户属性数据
* 物品属性数据
* 事件数据：用户发生的所有行为和动作
* 关系数据

#### 日志元素
* 用户ID
* 物品ID
* 事件名称
* 事件发生时间
* 曝光ID
    * 每次曝光的每个物品都会产生一个唯一ID
    * 用于将异构异地的日志串起来
    * 作为一个流量的快照记录


#### 工具

##### Kafka 分布式消息队列
* 按照Topic组织队列订阅消费模式，可以横向水平扩展
* 作为日志清洗计算层和日志收集之间的缓冲区

##### Fluentd 日志收集工具
* 提供了一个统一的日志层，解耦日志源和后端日志库


## 数据存储

### 特征数据
* 特点：数据量大、更新不频繁
* 包含：用户画像、物品画像


#### 稀疏的
* 包含：文本类、用户标签

##### 正排
* 含义：使用用户ID，物品ID作为主键进行查询
* 用途：线下模型学习
* 存储：使用列式数据库（HBase，Cassandra）

##### 倒排
* 含义：使用用户个人标签进行查询
* 用途：召回候选集
* 存储：使用KV数据库（Redis，Memcached）

#### 稠密的
* 包含：隐因子向量，嵌入向量
* 存储：使用文件存储，内存映射进行读取



### 模型数据
* 特点：键值对形式，更新比较频繁

#### 机器学习模型
* 存储：PMML格式，序列化成文件

#### 非机器学习模型


### 召回的候选数据

#### 特点
* ID列表形式

#### 类型
* 全局召回
* 用户召回（用户ID + 策略算法名称）

#### 存储
* 使用KV数据库


### 工具
* Cassandra
* Redis
* 磁盘存储


## AB实验

### 要素
* 流量：用户的访问
* 参数：各种组合
* 结果：实验过程中都需要日志记录

### 考虑点
* 实验的起止时间
* 实验的流量大小
* 流量的分配方式
* 流量的分配条件
* 流量如何无偏置
    * 流量分配的最大，最难问题
    * 同时做多个实验时，如果避免前面实验对后面实验产生影响

### AB重叠实验框架（Google）

#### 概念

##### 域
* 流量的一个大划分，流量进来首先要划分域
* 目的：做纵向划分，满足流量独占场景

##### 层
* 系统参数的一个子集，一层实验是对一个参数子集进行测试
* 目的：把互不相干的实验参数隔离开

##### 桶
* 存放实验组合对照组
* 实验进行的粒度

#### 实验分层

##### 目的
* 做重叠实验而不带来流量偏置

##### 原理
* 保证每一层面对的流量是当前域的100%流量

##### 注意点
* 每层分桶时，需要加上层ID。保证层之间分桶的独立性
* cookie,uuid散列成整数时，需要使用均匀的散列算法
* 取模要一致。保证良好的用户体验

##### 流量分配方式
* cookie+层ID 散列后取模
* 用户ID+层ID 散列后取模
* cookie+日期 散列后取模
* 完全随机


#### 实验数据分析

##### 解决问题
* 需要多少样本才能检测到所需灵敏度的指标变化
* 实验组和对照组是否存在差异，差异是偶然的还是真实的

##### 基本概念
* 原假设
    * 定义：想要通过统计数据推翻的假设
    * AB中指 实验组指标和对照组指标无显著差异
* 备择假设
    * 定义：原假设的相反
    * AB中指 实验组指标和对照组指标有显著差异
* 统计功效
    * 定义：如果备择假设为真，我们拒绝原假设的概率
    * 值越大，我们犯错的可能性就越小
* 置信度
    * 根据统计数据得出结论的可信度
    * 一般是95%，99%
    * 对应的是显著性性（p值）
* 置信区间
    * 由置信度，统计分布得出
    * AB中常使用Z分布（均值0，方差1的正态分布）

##### 计算所需样本量
* 确定的前置量：统计功效、显著性、灵敏度
* 使用公式估算最小样本量

##### 计算显著性
* AB中常使用Z检验



## 算法落地

### 协同过滤算法

#### 矩阵表示
* 将行为日志转换成稀疏矩阵存储格式来进行计算

#### 相似计算
* 通过采样算法来加速计算相似用户

#### 推荐计算
* 只需要计算相似用户喜欢过的物品
* 使用map-reduce进行集群计算
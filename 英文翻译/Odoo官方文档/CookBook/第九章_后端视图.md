

# 第九章_后端视图

[TOC]

## 添加菜单项和窗口动作

### 概述
* 最明显的让一个新功能对用户可见的方式就是增加一个菜单项


### 如何操作
在插件的XML数据文件中执行以下操作
1. 定义一个动作
    ```xml
    <act_window 
        id="action_all_customers"
        name="All customers"
        res_model="res.partner"
        view_mode="tree,form"         
        domain="[('customer_rank', '>', 0)]"    
        context="{'default_customer_rank': 1}" 
        limit="20"/>
    ```
1. 定义一个顶层菜单
    ```xml
    <menuitem id="menu_custom_top_level"
        name="My App Menu"
        web_icon="my_module/static/description/icon.png" />
    ```
1. 在菜单中引入动作
    ```xml
    <menuitem id="menu_all_customers"
         parent="menu_custom_top_level"
         action="action_all_customers"
         sequence="10"/>
    ```


### 工作原理
#### 步骤1
* act_window定义了一个使用列表视图显示所有顾客的窗口动作
* 属性说明
    * name: 用于显示所打开视图的标题
    * res_model: 所使用的模型
    * view_mode: 有效的视图类型列表，格式为逗号分隔的视图类型值
        * 默认值为tree,form 可以显示列表视图和表单视图
    * domain: 设置一个记录过滤器，过滤在视图中可以显示的记录
    * context: 设置一些在打开视图中有效的值
        * 例子中我们设置了顾客排名字段的默认值
    * limit: 设置在视图列表中可以显示的记录数量，默认值为80

#### 步骤2
* 在顶层菜单的最后菜单项后创建了一个菜单项
* 属性说明
    * name: 显示为菜单项的文本
        * 如果链接到了动作，就可以不设置该属性。会使用动作名字来显示
    * parent: 父菜单项的XML标识。顶层菜单项没有父菜单项
    * action: 被调用动作的XML标识
    * sequence: 用于兄弟菜单项的排序
    * groups: 设置可以访问该菜单项的用户组（设置多个）
        * 可选的，不设置所有用户都可以访问
    * web_icon: 只能用于顶层菜单


#### 视图查找
* 窗口动作会自动确定所使用的视图
* 通过目标模型和期望的类型（form,tree），选取sequence最小的视图


#### 简写XML标识
* act_window和menuitem都是简化的XML标识
* 如果不想使用，可以使用record标识创建ir.action.act_window和ir.ui.menu模型
* 例子
    ```xml
    <record id='action_all_customers' model='ir.actions.act_window'>
        <field name="name">All customers</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('customer_rank','>', 0)]</field>
        <field name="context">{'default_customer_rank': 1}</field>
        <field name="limit">20</field>
    </record>
    ```

#### 要点
* 注意menuitem简化形式中使用的名字不能直接在record元素中使用
    * parent需要换成parent_id
    * groups需要换成groups_id
* 为了构建菜单，web客户端会从ir.ui.menu模型中读取所有的记录，然后根据parent_id字段推断出菜单层次
* 菜单会根据模型上的用户权限和菜单、动作中的用户组来进行过滤
* 当用户点击一个菜单项时，对应的action会被执行


### 更多
#### target属性
* 窗口动作使用该属性来确定如何展示视图
* 可选值
    * current: 默认值，在web客户端主内容区打开视图
    * new: 在一个弹出窗口中打开视图
    * inline: 类似current，但是会在编辑模式下打开表单、禁止动作菜单
    * fullscreen: 视图会覆盖整个浏览器窗口，也会覆盖掉菜单
    * main: 类似current，但是会清除掉历史信息

#### 其他属性
* 这些属性在act_window标签中不支持，需要使用record标签
* res_id: 如果打开视图，可以通过设置该属性来打开一个特定的记录
    * 该功能常常用于多步骤向导、频繁修改一个特定记录
* search_view_id: 为tree,graph视图指定一个特定的搜索界面




## 使动作打开特定视图

### 如何操作
1. 定义最小化的tree,form视图
    ```xml
    <record id="view_all_customers_tree" model="ir.ui.view">
         <field name="name">All customers</field> 
         <field name="model">res.partner</field>
         <field name="arch" type="xml">
             <tree> 
                 <field name="name" />
             </tree>
          </field>
    </record>
    <record id="view_all_customers_form" model="ir.ui.view">
        <field name="name">All customers</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
           <form> 
               <group>
                   <field name="name" />  
               </group> 
           </form> 
        </field> 
    </record>
    ```
1. 定义窗口动作
    ```xml
    <record id="action_all_customers_tree" model="ir.actions.act_window.view"> 
        <field name="act_window_id" ref="action_all_customers" /> 
        <field name="view_id" ref="view_all_customers_tree" /> 
        <field name="view_mode">tree</field> 
        <field name="sequence" eval="2"/> 
   </record> 

   <record id="action_all_customers_form" model="ir.actions.act_window.view"> 
          <field name="act_window_id" ref="action_all_customers" />
         <field name="view_id" ref="view_all_customers_form" />
         <field name="view_mode">form</field>
         <field name="sequence" eval="2"/>
   </record>
    ```


### 工作原理
#### record标签
* 这次我们使用了通用的XML代码来定义视图和窗口动作
* record元素需要定义id和model属性
* id属性可以是任意的字符串，但是必须在插件中是唯一的
* model属性定义了需要创建的模型

#### 创建视图
* 如果要创建视图，我们需要为ir.ui.view模型创建一条记录
* 在元素中，需要设置定义在模型中的字段
* 对于ir.ui.view而言，重要的字段是model和arch
* model字段包含了视图所依赖的模型
* arch字段包括了视图本身

#### name字段
* 该字段严格意义上说不是必要的，主要用于在视图上调试问题
* 可以设置一个表明视图意图的字符串
* 该字段内容不会显示给最终用户，所以可以写一些技术类的信息
* 如果不写，会生成一个包含模型名和视图类型的默认值


#### ir.actions.act_window.view模型
* 步骤2定义的记录是和上一节定义的act_window协同工作的
* 通过设置view_id字段，我们可以为视图模式选择一个具体的视图
* 使用该模型可以细颗粒度的控制视图类型可以加载的视图



### 更多
* 我们可以使用record来替换act_window
    ```xml
    <record id='action_all_customers' model='ir.actions.act_window'> 
        <field name="name">All customers</field>
        <field name="res_model">res.partner</field> 
        <field name="view_mode">tree,form</field> 
        <field name="domain">[('customer_rank', '>', 0)]</field>
        <field name="context">{'default_customer_rank': 1,
            'tree_view_ref': 'my_module.view_all_customers_tree',
            'form_view_ref': 'my_module.view_all_customers_form' }
        </field>
        <field name="limit">20</field>
    </record>
    ```
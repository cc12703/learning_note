
# 性能优化



## 绘制优化


### 绘制原理

#### 应用层负责绘制，系统层负责渲染
* 应用程序把经过测量、布局、绘制后的surface缓存数据，通过SurfaceFlinger渲染到显示屏幕上
* 应用层绘制每个view都有三个步骤：measure，layout，draw(软件绘制、硬件加速)

#### 绘制过程
1. 应用层绘制到缓存区
2. SurfaceFlinger把缓存区数据渲染到屏幕
3. android的匿名共享内存保存缓存数据

#### 绘制分工
* CPU负责准备数据：包括 measure、layout、record、execute的数据计算
* GPU负责栅格化、渲染

### 刷新机制
* VSYNC(垂直同步) ：定时中断，CPU接收到后会立刻处理各帧数据
* Triple Buffer ： 三个数据缓存
* Choreographer ：在接收到VSYNC信号后，调用用户设置的回调函数

### 界面卡顿原因

#### 界面绘制
**绘制一帧内容耗时太长**

* 绘制的层级深
* 页面复杂
* 刷新不合理

#### 主线程
**主线程太忙，导致丢帧**


#### 数据处理 
* 数据处理占用CPU高，导致主线程拿不到时间片
* 内存增加导致GC频繁

### 工具

#### Profile GPU Rendering 

##### 功能
* 发现有问题的页面

##### 要点
* 图形监测工具，实时反应当前绘制的耗时
* 通过手机的开发辅助功能开启
* 使用adb shell dumpsys gfxinfo package-name 来导出日志

##### 显示构成
* 横轴为时间，纵轴为每一帧的耗时
* 每一根竖线表示一帧，由多个颜色构成，对应不同阶段的耗时
* 超过警戒线(绿线)，就有可能丢失了一帧

#### TraceView

##### 功能 
* 分析函数调用过程
* 分析每一个方法的执行时间

##### 显示构成
* 横轴为时间消耗，单位毫秒
* 纵轴为各个线程，使用不同颜色表示不同方法
* 颜色占用面积越宽，表示该方法占用CPU时间越长


# LVM

[TOC]


## 基础

### 原理
* 利用Linux的device-mapper功能来实现存储系统的虚拟化

### 功能
* 将多块硬盘看作一块大硬盘
* 逻辑卷可以跨多个硬盘
* 可以动态调整逻辑卷的大小
* 可以在线对逻辑卷、卷组进行操作
* 可以创建快照

### 组成
* PV 物理卷：一个可供存储的块设备
    * 一块硬盘，一个分区，一个回环文件
    * 包含一个特殊的LVM头
* VG 卷组：由物理卷组成的一个组
    * 作为存放逻辑卷的容器
* LV 逻辑卷：存放子啊一个卷组中，由物理块组成
* PE 物理块：一个卷组中最小的连续区域，默认为4MiB
    * 是物理卷的一部分
    * 可以被分配给逻辑卷

#### 图示
![](https://gitee.com/cc12703/figurebed/raw/master/img/20210226110857.png)




## 操作


### 命令
#### 创建
* pvcreate 创建物理卷
    * 格式：pvcreate device
* pvdisplay 查看物理卷

* vgcreate 创建卷组
    * 格式：vgcreate <卷组名> <物理卷> <物理卷> <物理卷> ...
* vgextend 扩展卷组
    * 格式：vgextend <卷组名> <物理卷>
* vgdisplay 显示卷组

* lvcreate 创建逻辑卷
    * 格式：lvcreate -L <卷大小> -n <卷名字> <卷组名>
* lvdisplay 显示逻辑卷

#### 挂载逻辑卷
1. 创建文件系统
    * 命令：mkfs.<文件系统类型> /dev/mapper/<卷组名>-<逻辑卷名>
1. 挂载
    * 命令：mount /dev/mapper/<卷组名>-<逻辑卷名> <挂载点>

#### 调整大小
* pvresize 调整物理卷大小
    * 格式：pvresize device  
        * 功能：自动将物理卷扩展到最大容器
* lvresize 调整逻辑卷大小
    * 格式：lvresize -L +10G --resizefs 卷组名/卷名 
        * 功能：卷大小扩大10GiB，同时扩大文件系统
    * 格式：lvresize -L +100%FREE --resizefs 卷组名/卷名
        * 功能：将卷组中所有剩余空间分配给卷，同时扩大文件系统

#### 重命名
* vgrename 重命名卷组
    * 格式： vgrename <旧的卷组名> <新的卷组名>
* lvrename 重命名逻辑卷
    * 格式：lvrename <卷组名> <旧的卷名> <新的卷名>

#### 移除
* lvremove 移除逻辑卷
    * 格式：lvremove 卷组名/卷名
    * 前提：移除所有的相关的挂载点
        1. lsblk  查看所有挂载点
        2. umount <挂载点>
* vgreduce 从卷组中移除物理卷
    * 格式：vgreduce <卷组名> device



## 其他

### 其他逻辑卷
#### 快照
* 使用了写入时复制策略
* 用于备份文件系统

#### 缓存
* 使用一个小而快速的逻辑卷，提供大而慢速的逻辑卷的性能
* 将大逻辑卷中频繁使用的物理块存储到小逻辑卷中
* 缓存逻辑卷会被分成两个：缓存数据逻辑卷、缓存元数据逻辑卷

#### RAID
* 一种创建逻辑卷的方法
* 使用多个物理设备来提高性能或容错能力
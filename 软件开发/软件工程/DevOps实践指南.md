
# DevOps实践指南


[TOC]

## 介绍

### 价值流

#### 技术价值流
* 把**业务构想**转化为向客户**交付价值**的，由技术驱动的服务所需要的**流程**

#### 指标
* 前置时间：从工单创建后开始计时，到工作完成时结束
* 处理时间：从实际开始处理这个工作开始计时，到工作完成时结束。（不包括排队等待时间）
* %C/A：完成时间和精确的总花费时间的百分比

#### 目标
* 缩短部署前置时间

#### 方法
* 采用测试运维与设计开发同步的模式
* 划分工作为小批量的工作
* 将质量内建到价值流的每个部分

#### 理想情况
* 开发人员能快速的、持续的获取工作反馈
* 能快速的，独立的开发、集成、验证代码，部署到生成环境


### 基础原则
**三步工作法**
1. 流动原则：实现开发到运维的工作快速流动
2. 实现持续的、快速的工作反馈机制
3. 建立企业文化

#### 流动原则
##### 方法
* 加强工作内容的可视化
* 减少每批次的大小和等待间隔
* 内建质量防止缺陷向下游传递


##### 使工作可见
* 使用**可视化工作板**
* 目的：为了能够识别工作在哪里流动、排队、停滞
* 已完成：应用程序在生产环境里成功地运行起来，并开始为客户提供价值
* 优点：利益干系人更容易从全局目标出发，确定各项工作的优先级

##### 限制在制品数
* 问题：多任务会导致更长的处理时间
* 优点：更容易发现工作中的阻碍

##### 减少批量大小
* 关键：通过小批量的模式完成工作
* 最小批量就是**单件流**
* 单件流可以通过持续部署实现

##### 减少交接次数
* 目的：让团队不必依赖其他人就可以独立为客户提供价值
* 自动化执行大部分操作
* 重新调整组织结构

##### 持续识别、改善约束点
* 环境搭建：自动化搭建
* 代码部署：自动化部署
* 测试准备和执行：自动化测试
* 紧密耦合的架构：创建松散耦合的架构

##### 消除价值流中的浪费
* 半成品：处于队列中的工作
* 额外工序：执行的并未给客户增值的额外工作
* 额外功能：构建那些客户完全不需要的功能
* 任务切换：将人员分配到多个项目和价值流中
* 等待：资源竞争而导致的工作间的等待
* 非标准或手动操作


#### 反馈原则

##### 复杂系统的特点
* 无法将系统视为一个整体，去理解各个部分是如何组合在一起的
* 相同的事情做两次，结果未必相同

##### 及时发现问题
* **通过在系统中建立反馈和前馈回路来实现**
* 建立自动化的构建、集成、测试，尽早的检测出导致缺陷的代码变更
* 建立监控系统，快速的探测到服务的意外情况

##### 群策群力，解决问题
* 目的：遏制住问题，防止蔓延，然后定位和处理问题，避免复发
* 只有尽可能在早期阶段，通过全民总动员的方式来解决小问题，才能把灾难性事故消灭在萌芽状态
* 阻止开展新工作有助于实现持续集成和部署

##### 在源头保障质量
* **让开发人员对系统质量负责**
* 根据同行评审来评定所提出的变更，确保按照设计运行
* 尽可能多用自动化方式执行QA和质量检查

##### 为下游工作中心而优化
* 我们最重要的客户是我们的下游，为他们而优化我们的工作
* 在技术价值流中，为运维而设计
* 运维的非功能性需求与用户功能同样重要


#### 持续学习与实验原则
* **能够持续提升个人技能，进而转化为团队和组织的财富**
* 技术价值流的核心：建立高度信任的文化，每个人都是持续学习者，必须在工作中承担风险

##### 建立学习型组织和安全文化
* 在每次事故发生后进行不指责的回顾，对发生原因和过程做出客观解释
* 不指责，员工就没有了恐惧，就可以做到坦诚，进而有效预防事故

##### 将日常工作的改进制度化
* 明确预留时间来改善日常工作
* 在每个开发周期的间歇预留一段时间

##### 把局部发现转化为全局优化
* 一旦在局部范围内取得成果，就应该把它分享给其他人
* 在技术价值流中，可以通过机制建立全局知识库

##### 在日常工作中注入弹性模式
* 通过在日常工作中持续不断地实验，可以提高生产效率和弹性
* 在技术价值流中，可以缩短部署的前置时间、提高测试覆盖率、缩短测试执行时间，来引入张力
* 通过演习的方式来预演大规模故障

##### 领导层强化学习文化
* 领导者必须要强调解决问题的能力和学习的价值
* 领导者帮助一线工作者在日常工作中发现并解决问题，是学习型组织的核心
* 领导者需要为团队创造条件，让团队在日常工作中做成正确的决定


## 切入点

### 选择合适的价值流

#### 项目类型
* 绿地项目：全新的软件项目，处于规划或实施的早期阶段
* 棕地项目：已经服务客户长达几年的产品或服务，有大量的技术债务
    * **棕地项目在转型时会面临大的阻碍，没有自动化测试、紧耦合架构**

#### 从最乐于创新的团队开始
* 不要再早期阶段，花费太多时间去改变保守的群体
* 应该集中在能创造成功且愿意承担风险的团队上

#### 扩大DevOps范围
* 尽早展示成果，并积极宣传
* 将大的改进目标分解成渐进式的小步骤

##### 步骤
1. 发现创新者和早期采用者：一开始，重点要在真正有意愿改进的团队上
2. 赢得沉默的大多数：扩大并建立更稳固的群众基础
3. 识别‘钉子户’

### 运用价值流

#### 组建团队
**团队组成**
* 产品负责人：业务方代言人
* 开发团队
* QA团队
* 运维团队
* 信息安全团队
* 发布经理：管理、协调生产环境部署和发布流程
* 技术主管（价值流经理）：保障价值流的产出满足客户的期望

#### 绘制价值流图
* 目标是识别出阻碍价值流快速流动的环节
* 要重点优化需要等待数周、数月的工作，或重大返工的工作
* 确定要改进的目标

#### 组建专门的转型团队
* **独立于负责日常运作的部门**
* 拥有共同的目标
* 保持小跨度的改进计划
* 为非功能性需求预留20%的开发时间
* 提高工作的可视化程度

#### 用工具强化预期行为
* 共享队列：统一任务列表，每个人都可以从全局角度思考优先级最高的事情
* 聊天室：自动记录聊天内容，可以在事后进行分析


### 组织结构
* **康威定律：系统设计受限于组织自身的沟通结构**
* 软件的架构和软件团队的结构时一致的
* 软件团队的结构对软件产品的架构和成果有着巨大的影响

#### 组织原型
##### 职能型
* 以专业技能为中心
* 有助于促进职业和技能的发展
* 具有多层次的组织结构

##### 市场型
* 注重快速响应客户需求
* 扁平化的结构，由多个跨职能部门组成


#### 职能导向
* **通过职能导向来取得DevOps成果**
* 价值流中的所有人都能意识到客户和组织的目标
* 要拥有高度信任的文化
* 所有部分都能够有效地协作
* 所有工作的优先级设置都是透明的

#### 将测试、运维、信息安全融入日常工作ß
* 保证质量、可用性、安全性不是某个部门的责任，而是所有人日常工作的一部分

#### 使团队成员成为通才
* 给工程师提供学习技能的机会
* 定期在不同的职位间轮岗

#### 投资于服务和产品，而非项目
1. 组建稳定的服务团队
2. 持续的提供资金
3. 让他们执行自己的战略和计划

#### 设定团队边界
* 理想情况：保证小团队能够独立运作，彼此充分解耦，避免过多不必要的沟通和协调


#### 创建松耦合架构
##### 保持小规模
* **团队通常在5-10人**
* 确保成员对系统有清晰、相同的理解
* 限制正在开发的产品或服务的增长率
* 分散权力并实现自主（团队负责人直接向管理层汇报）
* 让员工获得领导经验的一种方式


#### 将运维融入日常开发工作
##### 通用策略
* 构建自服务能力，帮助开发人员提高生产力
* 将运维工程师融入服务团队
* 若运维工程师人数紧张，采用运维联络人模式
* **开发团队和运维工程师的紧密配合和协作是一种极其有效的方式**


## 流动的技术实践

**通过持续交付来实现**

### 基础

#### 自动搭建环境
* 开发人员可以按需来搭建类生产环境
* 开发人员可以在安全隔离的情况下，快速地重现、定位、修复缺陷

##### 方法
* 复制虚拟化环境
* 构建自动化环境搭建流程
* 使用配置管理工具
* 使用操作系统自动化配置工具
* 使用虚拟镜像、容器
* 在公有云、私有云中创建环境

#### 统一的代码仓库
* 需要把环境相关的配置代码也纳入版本控制系统
* 需要把构建过程所依赖的一切也纳入版本控制系统
* 将对应有和环境所做的所有变更都纳入版本控制系统


#### 快速重建基础设施
**保证所有变更都能自动地被复制到所有环境中并被版本控制系统记录**

##### 不可变基础设施模式
* 生产环境不再允许任何手动操作
* 先将变更存入版本控制系统
* 从头开始重新构建代码和环境


#### 在类生产环境中验证
* 在类生产环境中集成和测试了可工作、可交付的代码
* 在类生产环境中使用与生产环境相同的工具


### 快速可靠的自动测试

#### 测试类型

##### 单元测试
* 独立测试每个方法、类、函数
* 确保代码按照开发人员的设计运行
* 用于证明应用的某一部分符合程序员的预期

##### 验收测试
* 整体测试应用
* 证明应用能满足客户的愿望

##### 集成测试
* 保证应用能与生产环境中的其他应用和服务正确交互
* 需要先通过了单元测试、验证测试才能进行集成测试

#### 最佳实践
* 每当验收测试和集成测试发现错误时，都应该编写对应的单元测试
* 尽量并行的快速执行测试
* 先编写自动测试用例，后写代码
* 尽量将手动测试自动化
* 从少量可靠的自动化测试开始
* 在测试套件中集成性能测试和非功能性测试

#### 测试失败时快速处理
* 当构建、单元测试失败时，需要告知整个团队
* 需要所有人要么去一起解决问题
* 每个人都会知道工作不只是‘编写代码’，更是‘运行服务’


### 持续集成
* 通过将合并融入日常工作，来解决合并代码的痛苦
* 基于主干的开发方式，需要创建更有效的自动化测试


#### 开发模式
##### 分支模式
* 每个人都在自己的分支上工作
* 每个人都独立地工作，不干扰其他人
* 代码合并会非常困难
* 合并难度越大，开发人员就越不可能改进和重构代码

##### 主干模式
* 所有人都在同一个区域里工作
* 没有分支，只有一条不可被中断的主干


#### 基于主干开发
* 每个开发人员每天至少向主干提交一次代码
* 每次提交代码后，就针对整个系统执行所有的自动化测试
* 迫使开发人员进一步分解工作，减少每次的提交量



### 低风险发布

#### 自动化部署
##### 步骤
* 打包代码成容易部署的格式
* 创建预配置的镜像或容器
* 自动化中间件的部署和配置
* 重启服务器、应用、服务
* 基于模块生成配置文件
* 执行自动化冒烟测试
* 自动化数据库迁移操作

##### 部署流水线
* 用相同的方式吹了所有环境的部署
* 对部署进行冒烟测试
* 维持环境的一致性

##### 发布流程
1. 构建：基于版本控制系统构建独立软件包（可部署到任何环境）
2. 测试：任何人在任何环境中都可以运行自动化测试套件
3. 部署：通过执行脚本可以将软件包部署到任何环境中


#### 部署和发布解耦
* 部署：在特定环境中安装指定版本的软件
* 发布：把一个特性提供给一部分客户

##### 发布模式
* 基于环境的发布：在多个环境中部署系统，但只有一个环境处理客户流量
* 基于应用的发布：修改代码，通过配置变更，选择性地开发应用特性

##### 蓝绿部署
* 有两个环境：蓝环境、绿环境
* 一个是生产环境，一个是预生产环境
* 任一时刻，只有一个环境处理客户流量（生产环境）
* 部署新版本时，只部署到预生产环境
* 测试正常后，切换两个环境
* 将数据库变更与应用变更解耦

##### 金丝雀部署
* 将环境分成多个环境组
* 从小环境组开发部署，逐渐到大环境组
* 监控软件在每个环境中的运行情况
* 一旦出现问题就回滚，不然就在下一个环境中部署

##### 特性开关
* 使用条件语句封装应用逻辑或用户界面元素
* 根据配置信息启用、禁用某个特性

###### 优点
* 轻松地回滚
* 缓解性能压力
* 提高恢复能力
* 实现黑启动：在生产环境中，对客户不可见的特性执行测试


### 降低发布风险

#### 演进式架构原则
* 任何成功的产品和公司，其架构都必须在生命周期里不断演进

##### 绞杀者应用模式
* 适用于将单体应用或紧耦合服务的部分功能迁移至松耦合架构

###### 方法
1. 将已有功能用API封装起来，避免对他们做变更
2. 在使用新架构的新服务中实现所有的新功能
3. 只有在必要的时候才调用旧系统的API


##### 面向服务的架构
* 每个对外服务都依赖于其他服务
* 每个服务都专注于某个特定功能
* 每个服务都由一个小型团队提供支持，负责构建和运行

###### 优点
* 让小型团队各自负责更小、更简单的开发任务
* 每个团队可以独立、快速、安全地进行部署


#### 架构原型

##### 单体架构1.0
所有功能都在一个应用里

###### 优点
* 开始简单
* 进程间延时低
* 一个代码库，一个部署对象
* 当规模小时，资源利用率高

###### 缺点
* 协调成本随团队规模增加
* 模块划分得不清晰
* 构建时间长
* 部署要么全面成功，要么彻底失败

##### 单体架构2.0
应用分成一组单体层：前端展示、应用服务器、数据库

###### 优点
* 开始简单
* 容易做连接查询
* 一个数据库模式、一个部署对象
* 当规模小时，资源利用率高


###### 缺点
* 耦合程度随时间提高
* 不容易扩展，冗余能力差
* 不容易调优


##### 微服务
模块化、独立、隔离的持久化

###### 优点
* 每个单元都是简单的
* 可扩展性和性能都是独立的
* 独立的测试和部署

###### 缺点
* 交互单元很多
* 需要很多小代码库
* 需要更复杂的工具和依赖项管理
* 网络延迟


## 反馈的技术实践

**把运维团队在下游获取的知识，整合到上游的开发和产品管理的工作中**

### 遥测系统

#### 集中式的监控架构
* 在业务逻辑、应用程序、环境层面收集数据
* 由一个独立系统来采集、存储、聚合所有的监控信息

#### 度量指标
* 业务级别：交易订单数量、用户注册数
* 应用程序级别：事务处理时间、用户响应时间、应用程序故障
* 基础架构级别：吞吐量、CPU负载、磁盘使用率
* 客户端级别：出错率、事务处理时间
* 部署流水线级别：流水线状态、部署频率、环境状态

##### 要点
* 将业务指标和应用程序、基础架构指标聚合在一起显示，有助于发现故障
* 需要预生产环境中进行监控，有助于提前发现并解决问题


#### 识别潜在问题
##### 标准差
* 用法：定期检查数据集的某个度量，如果与均值有显著差异就告警
* 条件：数据要符合正态分布

##### 异常检测
* 在数据不是正态分布的情况下，搜索不符合预期模式的数据条目


#### A/B测试
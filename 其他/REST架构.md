[TOC]

# REST架构

## 概念

* REST是Representational State Transfer缩写，翻译为 表示层状态转化

### 资源

 * 资源是指网络上一个实体，可以是一段文本、一张图片、一首歌曲、一种服务
 * 可以使用URI来指向它，每种资源对应一个特定的URI

### 表现层

 * “资源”是一种信息实体，它可以有多种外在表现形式
 * 我们把”资源”具体呈现出来的形式，叫做它的”表现层”
 * URI只代表资源的实体，不代表它的形式
 * 它的具体表现形式，应该在HTTP请求的头信息中用Accept和Content-Type字段指定

 #### 例子

  * 文本可以用txt格式表现，也可以用HTML格式、XML格式、JSON格式
  * 图片可以使用JPG格式或PNG格式表现

### 状态转化

 * HTTP协议，是一个无状态协议，所有的状态都保存在服务器端
 * 如果客户端想要操作服务器，必须通过某种手段，让服务器端发生”状态转化”
 * HTTP协议里面，四个表示操作方式的动词：GET、POST、PUT、DELETE。它们分别对应四种基本操作

 #### HTTP操作

  * GET用来获取资源
  * POST用来新建资源（也可以用于更新资源）
  * PUT用来更新资源
  * DELETE用来删除资源

### RESTful架构

 * 每一个URI代表一种资源
 * 客户端和服务器之间，传递这种资源的某种表现层
 * 客户端通过四个HTTP动词，对服务器端资源进行操作，实现”表现层状态转化”



## 设计指南

### 总体

 * 总是使用HTTPs协议
 * 数据格式总是使用JSON
 * 提供内容协商能力

### 域名

 * 应该尽量将API部署在专用域名之下

### 版本

 * 方案1： 版本号放入URL   https://api.example.com/v1/
 * 方案2： 版本号放入HTTP头信息

### 路径

 * 指API的具体网址，网址中不能有动词，只能有名词


### 动词

#### 常用动词

 * GET（SELECT）：从服务器取出资源（一项或多项）
 * POST（CREATE）：在服务器新建一个资源
 * PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）
 * PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）
 * DELETE（DELETE）：从服务器删除资源

#### 不常用动词

 * HEAD：获取资源的元数据
 * OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的


### 状态码

 * 1xx：相关信息
 * 2xx：操作成功
 * 3xx：重定向
 * 4xx：客户端错误
 * 5xx：服务器错误

### 错误处理

 * 如果状态码是4xx，就应该向用户返回出错信息
 * 一般来说，返回的信息中将error作为键名，出错信息作为键值即可

 ```http
 {
    error: "Invalid API key"
 }
 ```

### 缓存处理

 * 使用Cache-control来控制缓存 
 * 使用Etag 或者 Last-Modified 来处理数据是否变动


### 安全性

#### 请求数据验证

 * 验证请求头信息是否合法：出现了不该出现的头信息，没有出现必须包含的头信息
 * 验证请求URI和内容是否合法

#### 数据完整性验证

 * 底线是：保证要修改的数据和服务器里的数据是一致的，可以使用Etag来完成

##### Etag方案

 * Etag可以认为是某个资源的一个唯一的版本号 

###### 过程

  1. 当客户端请求某个资源时，该资源的Etag一同被返回
  1. 当客户端需要修改该资源时，需要通过”If-Match”头来提供这个Etag
  1. 服务器检查客户端提供的Etag是否和服务器同一资源的Etag相同
  1. 如果相同，才进行修改，否则返回412

  
  
#### 访问控制

 * 所有的API的所有操作均需得到授权
 * 授权方式：如HTTP BASIC Auth，OAuth，HMAC Auth等 
 * 授权的含义：验证某个请求是由一个合法的请求者发起 

##### HMAC Auth 

 * 保证一致性：请求的数据在传输过程中未被修改，因此可以安全地用于验证请求的合法性 
 * 格式：
 ```
   Date: Mon, 26 Mar 2007 19:37:58 +0000 
   Authorization: access-key : HMAC值
 ```
 * 服务端会生成 access-key 和 access-secret（客户端保存好） 
 * HMAC值是使用access-secret按照要求对请求头或请求内容计算而来的

## 最佳实践

 * 给API加上版本号
 * 使用名词来表示资源
 * GET、HEAD操作应用是安全的，无副作用的
 * 对于超大结果集，应该进行分页处理
 * 发送错误时，返回一致的错误描述


 ## 参考资料

 * http://www.ruanyifeng.com/blog/2011/09/restful.html
 * http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html
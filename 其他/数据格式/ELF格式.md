
[TOC]

# ELF格式


## 基本介绍
* ELF -> Executable and Linking Format (可执行链接格式)
* 是应用程序二进制接口的一部分。


### 三种类型
* 可重定位文件（.o文件）：中间格式
* 可执行文件（.exe文件）
* 共享目标文件（.so文件）：可用于链接编辑器和动态链接器


## 文件格式

* 包含两种并行视图：链接视图、执行视图
* **除了ELF头部外，其他节和段都没有规定的顺序**

### 链接视图

|  链接视图  |   
| :--------: | 
|  ELF头部  | 
| 程序头部表（可选）|
|  节区 1   |  
|  节区 n   |
|  节区头部表 |  

### 执行视图

|  执行视图  |   
| :--------: | 
|  ELF头部  | 
| 程序头部表|
|  段 1   |  
|  段 n   |
|  节区头部表（可选） |  



### ELF头部

|  字段名  |  含义  |
| :--------: |  :--------: | 
| ident[]  |  ELF标识信息 | 
|  type | 文件类型（REL, EXEC, DYN） |
| machine | 机器类型 |
| version | 版本号 |
| entry | 程序入口的虚拟地址| 
| phoff | 程序头部表的偏移量|
| shoff | 节区头部表的偏移量|
| flags | 特定于处理器的标识|
| ehsize | ELF头部大小 |
| phentsize | 程序头部表的表项大小 |
| phnum | 程序头部表的表项个数 |
| shentsize | 节区头部表的表项大小 |
| shnum | 节区头部表的表项个数 |
| shstrindex| 节区名字字符串表的表项索引值|


#### EFL标识
* MAG0 --- MAG3  魔数，值为 0x7f, 'E', 'L', 'F'
* CLASS 目标机器类型，值为 0 非法，1 32位，2 64位
* DATA 目标数据编码方式，值为 0 非法，1 高位在前，2 低位在前

### 程序头部

|  字段名  |  含义  |
| :--------: |  :--------: | 
| type | 类型|
| offset | 文件偏移量（从文件头开始）|
| vaddr | 内存起始虚拟地址 |
| paddr | 用于物理地址相关 |
| filesize | 在文件映像中所占的字节数|
| memsize | 在内存映像中所占的字节数 |
| flags | 相关的标志|
| align | 内存地址对齐值 |

#### 类型
* LOAD  是一个可加载的段
* DYNAMIC  描述动态链接信息
* INTERP  描述解释器

### 节区头部

|  字段名  |  含义  |
| :--------: |  :--------: | 
| name | 节区名字，在字符串节区中的索引值|
| type | 类型 | 
| flag | 标识 （WRITE, ALLOC, EXECINSTR）|
| addr | 地址 | 
| offset | 在文件中的偏移量|
| size | 节区大小 | 
| link | 链接信息 |
| info | 额外信息 | 
| addralign | 内存地址对齐值 |
| entsize | 节项大小 |


#### 类型
* PROGBITS 包含程序定义信息，格式和含义由程序解析
* SYMTAB  包含一个符号表
* STRTAB 包含一个字符串表
* RELA  包含一个重定位表
* HASH 包含一个符号哈希表
* DYNAMIC 包含动态链接信息
* REL 包含一个重定位表
* DYNSYM  包含一个完整的符号表


### 字符串表
* 包含以NULL(ASCII码 0)结尾的字符序列

### 符号表
* 包含用于定位，重定位程序中符号定义和引用的信息

#### 符号表项
|  字段名  |  含义  |
| :--------: |  :--------: | 
| name | 名字，字符串表的索引|
| value | 值，依赖于具体的上下文|
| size  | 大小 | 
| info  | 绑定属性|
| other | 当前为0|
| shindex | 节区头部的索引 |



# Git原理

[TOC]

## 特点
* 直接记录快照，而非差异比较
    * Git只关心文件数据的整体是否发生变化
    * 并不保存这些前后变化的差异数据，而是把变化的文件进行快照处理
* 绝大部分操作都是本地执行
    * 在Git中的绝大多数操作都只需要访问本地文件和资源，不用连网
    * 因为Git在本地磁盘上就保存着所有当前项目的历史更新
* 时刻保持数据完整性
    * 在保存到Git之前，所有数据都要进行内容的校验和计算，并将此结果作为数据的唯一标识和索引
    * Git使用SHA-1算法计算数据的校验和，将此作为指纹字符串
* 多数操作仅添加数据
    * 常用的Git操作大多仅仅是把数据添加到数据库



## 基础

### 文件状态
* 已提交(commited)
    * 表示该文件已经被安全地保存在本地数据库中了
* 已修改(modified)
    * 表示修改了某个文件，但还没有提交保存
* 已暂存(staged)
    * 表示把已修改的文件放在下次提交时要保存的清单中

### 工作区域
* 工作目录
    * 从git仓库中取出的某个版本的所有文件和目录
* 暂存区域
    * git中的一个文件，保存修改后文件的快照
* 本地仓库
    * 用来保存元数据和对象数据库



## 命令
Git的命令分为高层命令和底层命令




## 内部原理

### 概述
 * Git底层是一个微型的内容寻址系统
 * 可以使用KV来存储任何类型的数据
 * key就是指纹字符串

### 数据存储
数据保存在.git目录下

#### config
* 仓库的配置文件

#### HEAD
* 保存当前所在的位置，内容为指纹字符串

#### index
* 暂存区
* 二进制文件，存放了排好序的路径
* 每个条目包括 对象的SHA-1值和访问权限

#### objects/
* 保存所有的数据，分成三个类型：Blob, Tree, Commit

#### objects/pack/
* 保存所有的打包文件

#### refs/
* 保存所有的引用文件：本地分支，远端分支，标签，内容为指纹字符串

#### logs/
* 存放各个refs的历史信息

#### hooks/
* 存放系统默认的钩子脚本



### 对象模型
#### SHA
* 每个对象都会使用SHA-1来计算校验和，作为对象名字

#### 类型
* Blob 文件
* Tree  目录
* Commit 提交
* Tag 标签

#### 结构
* 组成：对象类型值(blob, tree, commit, tag) + 大小 + 内容

##### Tree内容
* 权限模式
* 类型
* 校验和
* 文件名

##### Commit内容
* 当前快照的顶层树对象
* 作者信息，提交者信息
* 当前时间戳
* 提交注释信息


#### 存放格式
##### 松散对象
* 访问代价比较低，空间占用大
* 每个对象都被写入一个单独的文件中
* 对象会被压缩存储(gzip格式)
* SHA-1的头两个字符作为子目录名，其余字符作为文件名

##### 打包对象
* 访问代价比较高，空间占用小
* 只会保存修改了的部分
* 存放在objects/pack/目录下
* 包括 打包文件(.pack) 和 打包文件索引(.idx)




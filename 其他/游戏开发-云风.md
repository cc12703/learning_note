


# 游戏开发-云风


## 系统整体

### 模块
#### 客户端
* 运行在用户的PC上，使用TCP连接到游戏服务器网关

#### 网关
* 负责汇总所有的客户端
 
#### 客户端代理
* 运行在网关之后
* 逻辑上，每个客户端对应一个agent，用于翻译、转发客户端请求和回应
* 使用 lua state来实现单个agent
                             
#### 数据服务
* 保存玩家数据、场景数据
* 数据库使用Redis

#### 场景管理器
* 用于管理静态场景和动态副本
 
#### 场景服务器
* 用于玩家在里面做漫游

### 设计要点
* 网关之后的服务是相互信任的，组成一个虚拟网络可以相互通讯
* 设计核心是 agent


### 依赖模块
* 通讯底层使用 ZeroMQ
* 通讯协议使用 google protobuf
* 游戏逻辑使用 lua脚本


## agent
* agent是系统的设计核心

### 主体逻辑：
1. 等待用户认证
2. 将信息交给认证服务器认证，失败则返回1
3. 从数据库中获取用户信息，转发给客户端
4. 取到用户所在的场景号，从场景管理器中取到场景服务的位置，并申请加入场景
5. 从场景服务器中同步环境
6. 转发用户在场景中的漫游请求，并同步场景的实时数据
7. 若客户端发生异常或退出，则通知场景服务器离开

### 要点
* agent是一个包驱动模式，每个包都有相关的上下文环境
* 游戏逻辑由若干个流程构成，每个流程中服务器会接收若干类型的包
    * 大多数数据包可以立刻处理完成
    * 部分数据包需要开启一个子流程处理，父流程等待完成
    * 部分数据包需要开启一个并行流程处理，与其他流程并存运行
* 使用DSL来描述逻辑，用协程来实现
* 整个框架就是一个协程调度器，每个执行流程都是一个协程



## 数据库设计

* 使用redis保存数据，提供基本的KV存储功能

### 数据格式

#### 用户数据(account)
* 使用email做用户名，在数据库中使用UID作为唯一标识

| 字段名 | 数据类型 | 含义 |
| -- | -- | -- |
| ccount | id | 用户唯一标识 |
| version | number| 数据格式版本 | 
| email | string | 用户名 | 
| password | string | 密码，使用md5保护 |
| nickname | string | 呢称 | 
| lastlogin | hash | 最后一次登陆信息（登陆IP,登陆时间） |
| history | list(string) | 登陆历史 | 
| available | enum | 有效标识 | 
| avatars | set(id) | 游戏角色 | 

#### 游戏角色数据(avatar)
| 字段名 | 数据类型 | 含义 |
| -- | -- | -- |
| ccount | id | 游戏角色唯一标识 |
| version | number| 数据格式版本 | 
| account | id | 所属用户的标识 | 
| scene | string | 角色所在的场景名 | 
| available | enum | 有效标识 | 
| data | hash | 角色数据 | 

#### 场景数据(scene)
| 字段名 | 数据类型 | 含义 |
| -- | -- | -- |
| ccount | id | 场景唯一标识 |
| name | string | 场景名字 | 
| available | enum | 有效标识 | 
| info | hash | 场景数据 | 
| pc | hash | PC的在线状态 |



## 场景服务

### 作用
* 同步每个agent看到的世界
* 使每个agent可以了解场景中发生的变化
* 当agent进入场景时，可以获取整个世界的状态，可以查询到离开时的自己的状态

### 并发处理
* 场景数据是局部累积的一种缓慢变化，所以不需要各方都读取到最新数据
* 使用trip-buffer 来避免读写锁

### 模块
#### 副本管理器
* 管理地图服务的地址

#### 地图服务
* 管理其中所有的角色
* 管理所有的NPC和怪


 ## NPC管理
 * 原始文档：http://blog.codingnow.com/2012/05/dev_note_19.html



## 背包系统
* 原始文档： http://blog.codingnow.com/2012/07/dev_note_22.html


## 共享存储系统
### 概述
* 一个内存数据库
* 核心部分仅仅实现了结构化数据在内存中的表达, 实现的是无锁的数据结构     
* 需要在lua接口层做一个cache
* 定义一个数据描述的小语言


## skynet
* 原始文档： http://blog.codingnow.com/2012/09/the_design_of_skynet.html

### 概述
* 一个服务器底层框架
* 解决玩家的接入问题
* 管理各个服务间的数据流向
* 管理服务的启动、停止

### 功能
* 可以向skynet发送一条指令，并能立刻返回一个结果
* 向skynet发送数据，由其决定数据发送到何处
* 注册一个回调，当skynet有消息送达时触发


### 集群设计
* 原始文档：http://blog.codingnow.com/2012/08/skynet_harbor_rpc.html
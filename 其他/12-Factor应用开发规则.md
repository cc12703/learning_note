

# 12-Factor应用开发规则

[TOC]



## 基准代码

### 一份代码，多份部署
* 每份部署相当于运行了一个应用的实例
* 所有部署的基准代码相同，但每份部署可以使用其不同的版本



## 部署环境

* 一个生产环境
* 一个、多个预发布环境
* 开发人员的本地环境


## 依赖

### 显示声明依赖关系
* 不隐式依赖系统级的类库，一定通过依赖清单，确切地声明所有依赖项
* 运行过程中使用 依赖隔离 工具来确保程序不会调用系统中存在但清单中未声明的依赖项
* 无论什么工具，依赖声明和依赖隔离必须一起使用
* 不隐式依赖某些系统工具，这些工具应该被包含在应用中



## 配置

### 在环境中存储配置
* 代码和配置要严格分离
* 配置并不包含应用的内部配置
* 推荐将配置存储于 环境变量 中
* 环境变量的粒度要足够小，且相对独立


#### 环境变量优点
* 不会不小心被签入到代码库中
* 与语言和系统无关
* 非常方便在不同部署间做修改



## 后端服务

### 将后端服务当作附件资源
* 不要区别对待本地或者第三方服务，都是附加资源
* 通过一个url或存储在配置中的服务定位来获取数据
* 每个不同的后台服务是一份资源 （两个MySQL数据库会被当作两个不同的资源）
* 部署可以按需加载或卸载资源


## 构建、发布、运行

### 严格分离构建和运行
* 严格区分 构建、发布、运行 三个步骤
* 每个发布版本必须对应一个唯一的发布ID


### 三阶段
* 构建阶段：将代码库转换为可执行包
* 发布阶段：将构建结果和当前部署需要的配置相结合
* 运行阶段：针对选定的发布版本，在执行环境中启动应用进程



## 进程

### 以一个、多个无状态进程运行应用
* 应用进程必须是无状态，无共享的
* 任何需要持久化的数据都要存储在 **后端服务** 中
* 内存或磁盘可以作为某种事务型操作时的缓存




## 端口判定

### 通过端口绑定来提供服务
* 需要完全自我加载，不依赖任务网络服务器就可以创建一个面向网络的服务
* 通过端口绑定来提供服务，并监听发送至该端口的请求



## 并发

### 通过进程模型进行扩展
* 进程是一等公民，主要借鉴于unix守护进程模型
* 将不同的工作分配给不同的进程类型
* 应用进程不需要守护进程或写入PID文件，要借助操作系统的进程管理器



## 易处理

### 快速启动和优雅终止可最大化健壮性
* 进程应当追求 最小启动时间
* 接收到 终止新，需要优雅的终止
* 需要在突然死亡时保持健壮


## 开发环境与线上环境等价

### 尽可能的保持开发、预发布、线上环境相同
* 需要做到 持续部署，必须要缩小本地与线上差异
* 不应该在不同环境间使用不同的后端服务


### 差异点
* 时间差异
* 人员差异
* 工具差异

### 缩小措施
* 开发人员可以几小时、或者几分钟就部署代码
* 开发人员不只要编写代码，还需要参与部署过程以及线上的表现
* 尽量保证开发环境以及线上环境的一致性



## 日志

### 把日志当作事件流
* 日志应该是 事件流 的汇总，将所有运行进程和后端服务的输出流按照时间顺序收集起来
* 应用本身不应该考虑存储自己的输出流



## 管理进程

### 后台管理任务当作一次性进程运行
* 一次性管理进程应该和正常的常驻进程使用相同的环境
* 后台管理代码应该随其他应用程序代码一起
* 所有进程类型应该使用同样的 依赖隔离 技术



## 一次性任务
* 数据移植任务
* 检查线上数据库
* 一次性脚本
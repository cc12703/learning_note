

# JVM运行时

## 综述

* java虚拟机是一份抽象规范，一个具体的实现，一个运行中的实例
* java虚拟机的主要任务：装载class文件，执行字节码，实现功能（自动垃圾回收、异常处理、多 线程）

## 编程语言

* java是面向对象的编程语言： 类（类型），对象（实例）

### 类
```java
public class example { 
    private int test = 0; 
    
    public test() { 
        test += 1; 
    } 
}
```

### 对象
```java
example obj = new example(); 
obj.test();
```

## java体系结构

* 面向以网络为核心的硬件环境

### 组成
* java 程序设计语言 
* java class文件格式 
* java 应用编程接口 
* java 虚拟机

### 特性

#### 平台无关性 
* class文件基于虚拟机的，独立于平台 
* java语言的基本数据类型是平台无关的 

#### 安全性 
##### java沙箱安全模型
* 类装载器体系结构 
* class文件检验器 
* java虚拟机中的安全特性 
* java API中的安全管理器 

#### 网络移动性 
* 紧凑的class文件
* 动态连接与动态扩展
* jar文件

### 缺点

* 执行速度慢 
* 最小公分母问题


## 结构框图

![](https://gitee.com/cc12703/figurebed/raw/master/img/20201120195228.png)

### 说明

#### 类装载器
* 装载、连接、初始化 类（二机制的class文件）

#### 方法区：
* 保存被装载的类型信息（基本类型信息、常量池、字段信息、方法信息） 

#### 堆
* 保存运行时创建出的对象 
* 运行时数据区 --- 线程共享

#### 程序计数器
* 每个线程都有一个独立的PC寄存器
* 保存下一条被执行指令的地址 

#### java栈
* 以栈帧为单位保存线程的运行状态 
* 栈帧包括：局部变量区、操作数栈、帧数据区 

#### 执行引擎
* 执行指令集 
* 使用多种方法实现（解释、即时编译、硬件） 

#### 本地方法接口
* 使本地方法来访问运行时数据区 
* 使用JNI、KNI，或自定义


## 方法调用

### 方法类型
* 类方法：使用静态绑定（编译时), 基于方法引用的类型 
* 实例方法：使用动态绑定（运行时), 基于参数对象的类

### 方法栈
* 由多个栈帧组成
* 栈帧： 一次调用的栈数据

#### 栈帧结构
* 局部变量区 (方法参数、局部变量) 
* 操作数栈 (工作区) 
* 栈数据区 (自定义,一般用于实现异常派发机制) 

### 方法调用
1. 在调用一个方法前，编译器会将参数压入当前栈帧的操作数栈 
2. 虚拟机需要弹出这些参数，并放入新栈帧的局部变量区 
3. 从一个方法返回前，虚假机需要将返回值压入前一个栈帧的操作数栈


## 垃圾回收

### 功能
* 内存回收：自动识别所有不再被使用的内存块，可以重新使用这些内存

### 要解决的问题
1. 如何检测出垃圾对象
2. 如何回收无用的内存空间(处理内存碎片)

### 类型

#### 基本算法
1. 引用计数收集 
2. 标记压缩收集 
3. 标记拷贝收集

#### 高级算法
1. 按代收集 
2. 渐进式收集

### 算法描述

#### 引用计数收集 
##### 要点
* 每个对象有一个引用计数 
* 其他变量被赋值为该变量时，计数加1 
* 其他变量被赋值其他值时，计数减1 
* 计数为0的被当作垃圾对象 

##### 优点
* 可以快速地执行，交织在程序运行中 

##### 缺点
* 无法检测出循环引用对象


#### 标记清除算法
##### 要点
* 在标记阶段，每次都要对全部对象进行标记 
* 从根对象集开始标记遇到的对象 
* 根对象集包括：
    * 局部变量中的对象引用
    * 操作数栈中的对象引用 
    * 被加载类中的对象引用
    * 本地方法中的对象引用 
* 在清除阶段，处理未被标记的对象 

##### 缺点
* 执行时间比较长，且不确定，与对象个数成正比

#### 标记压缩收集 
##### 要点
* 分为两个步骤：标记、压缩


## 异常 

* 将正常流程与错误处理流程分离的一种方法 
* java在 语法、class文件、指令集 上支持异常 

### 语法级
* 关键字：try, catch, finally, throw 

### class文件
* 每个方法都会带异常表 
* 每个try语句块捕获的异常都在异常表中占一项 

### 指令集
* athrow  抛出异常

## 线程同步

* **同步机制：监视器**

### 监视器
* 监视器监视一段区域（一段不可分割的代码块） 
* 线程在进入这段区域前要获得监视器 
* 线程在退出这段区域后要释放监视器
* 具有 等待并唤醒 特性

#### 等待并唤醒 
* 等待会使线程停止运行
* 但唤醒并不马上使线程运行
* 直到监视器切换时才会运行

### 对象锁
* 虚拟机内部用于互斥共享数据（堆中的实例变量、方法区中的类变量） 
* 每个对象和类在逻辑上都与一个监视器相关联 
* 每个对象和类都关联一个对象锁 
* 类上锁实际上是对类的java.lang.Class对象上锁

### 功能点
* 互斥：通过对象锁来实现 
* 协作：通过Object类的wait方法和notify方法来实现

### 实现支持
* 语法支持： synchronized 关键字，加在一段代码上、修饰一个方法 
* 指令集支持：monitorenter、monitorexit 
* Object类方法：wait(), notify(), notifyAll()


## 本地方法

### 目的
* 为了使用底层操作系统提供的功能，与其他语言进行交互

### 实现方法
* PC平台: JNI、动态链接库 
* 手机平台: KNI、与vm一起编译

### 本地方法接口 
* JNI、KNI 
* 提供一组统一的接口，使本地方法可以使用vm的部分功能 
* KNI是JNI的一个子集 
* 功能：对象操作、类/接口操作、字段操作、方法调用